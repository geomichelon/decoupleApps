name: CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

jobs:
  pr-checks:
    if: github.event_name == 'pull_request'
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 15.x
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Ensure scripts are executable
        run: chmod +x Tools/*.sh

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
            Modules/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('Modules/Package.swift') }}

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-derived-

      - name: Dependency rules (SPM)
        run: bash Tools/check_spm_dependency_rules.sh

      - name: Import boundaries
        run: bash Tools/check_import_boundaries.sh

      - name: Checkout gating/bypass check
        run: bash Tools/check_checkout_bypass.sh

      - name: Contract deprecation policy check
        run: bash Tools/check_contract_deprecation_policy.sh

      - name: SPM tests
        run: bash Tools/run_tests.sh

      - name: Generate dependency graph
        run: bash Tools/gen_dependency_graph.sh

      - name: Ensure graph is committed
        run: git diff --exit-code Docs/diagrams/dependency-graph.mmd

      - name: Upload dependency graph
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: Docs/diagrams/dependency-graph.mmd

  main-builds:
    if: github.event_name == 'push'
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        scheme: [SuperApp, CatalogApp, CheckoutApp, ProfileApp]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 15.x
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build (${{ matrix.scheme }})
        run: |
          mkdir -p ci-logs
          xcodebuild \
            -project DecoupledApps-iOS.xcodeproj \
            -scheme "${{ matrix.scheme }}" \
            -destination "generic/platform=iOS Simulator" \
            CODE_SIGNING_ALLOWED=NO \
            build | tee "ci-logs/${{ matrix.scheme }}.log"

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.scheme }}
          path: ci-logs/${{ matrix.scheme }}.log
